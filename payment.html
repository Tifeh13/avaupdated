<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Payment ‚Äî Ava Jewelry</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=Montserrat:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--gold:#D4AF37;--gl:#FFD700;--gg:rgba(212,175,55,.22);--black:#070707;--dark:#0f0f0f;--card:#141414;--card2:#1a1a1a;--border:rgba(212,175,55,.12);--bh:rgba(212,175,55,.45);--white:#F5F0E8;--wd:rgba(245,240,232,.6);--wf:rgba(245,240,232,.3);--gray:#666;--nh:72px;--ah:42px}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}html{scroll-behavior:smooth}
body{background:var(--black);color:var(--white);font-family:'Montserrat',sans-serif;overflow-x:hidden;cursor:none}
a{text-decoration:none;color:inherit}button{font-family:'Montserrat',sans-serif;cursor:none}
.cur{width:10px;height:10px;background:var(--gold);border-radius:50%;position:fixed;top:0;left:0;pointer-events:none;z-index:99999;transform:translate(-50%,-50%);transition:width .3s,height .3s;mix-blend-mode:difference}
.cur.ex{width:40px;height:40px}
.cring{width:38px;height:38px;border:1px solid rgba(212,175,55,.7);border-radius:50%;position:fixed;top:0;left:0;pointer-events:none;z-index:99998;transform:translate(-50%,-50%)}
.ann{background:var(--gold);height:var(--ah);display:flex;align-items:center;justify-content:center;overflow:hidden}
.ann-t{display:flex;align-items:center;gap:4rem;animation:annS 22s linear infinite;white-space:nowrap}
.ann-i{font-size:.62rem;letter-spacing:.28em;text-transform:uppercase;color:var(--black);font-weight:600;display:flex;align-items:center;gap:.8rem}
.adot{width:4px;height:4px;background:var(--black);border-radius:50%;opacity:.4}
@keyframes annS{from{transform:translateX(0)}to{transform:translateX(-50%)}}
.nav{position:sticky;top:0;height:var(--nh);background:rgba(7,7,7,.97);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);z-index:1000;display:flex;align-items:center;padding:0 3rem;gap:2rem}
.logo{font-family:'Cormorant Garamond',serif;font-size:1.6rem;font-weight:300;letter-spacing:.35em;color:var(--gold);line-height:1;flex-shrink:0}
.logo small{display:block;font-size:.45rem;letter-spacing:.55em;text-transform:uppercase;color:var(--wf);font-family:'Montserrat',sans-serif}
.nav-r{margin-left:auto;display:flex;align-items:center;gap:.6rem}
.nib{position:relative;width:38px;height:38px;display:flex;align-items:center;justify-content:center;border:1px solid transparent;border-radius:2px;font-size:1.05rem;color:var(--wd);transition:all .3s;background:transparent}
.nib:hover{color:var(--gold);border-color:var(--border)}
.nbadge{position:absolute;top:3px;right:3px;background:var(--gold);color:var(--black);font-size:.48rem;font-weight:700;width:14px;height:14px;border-radius:50%;display:flex;align-items:center;justify-content:center}
.tbox{position:fixed;bottom:2rem;right:2rem;z-index:9000;display:flex;flex-direction:column;gap:.8rem;pointer-events:none}
.toast{background:var(--card);border:1px solid var(--border);border-left:3px solid var(--gold);padding:.9rem 1.4rem;display:flex;align-items:center;gap:.8rem;min-width:260px;animation:tIn .4s ease;font-size:.72rem;box-shadow:0 8px 30px rgba(0,0,0,.6);pointer-events:auto}
.toast.out{animation:tOut .4s ease forwards}
@keyframes tIn{from{transform:translateX(80px);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes tOut{to{transform:translateX(80px);opacity:0}}
/* PAGE LAYOUT */
.pwrap{max-width:1100px;margin:0 auto;padding:3.5rem 5rem}
.cbc{display:flex;align-items:center;gap:.6rem;font-size:.57rem;letter-spacing:.25em;text-transform:uppercase;color:var(--gray);margin-bottom:2.5rem}
.cbc a{color:var(--gray);transition:color .2s}.cbc a:hover{color:var(--gold)}
.cbc-sep{color:rgba(212,175,55,.3)}
.ctitl{font-family:'Cormorant Garamond',serif;font-size:clamp(2rem,4vw,3rem);font-weight:300;margin-bottom:.5rem}
.ctitl em{color:var(--gold);font-style:italic}
.cstep{font-size:.6rem;letter-spacing:.2em;color:var(--gray);margin-bottom:3rem}
.pg2{display:grid;grid-template-columns:1fr 360px;gap:3rem;align-items:start}
/* Payment method tabs */
.pay-tabs{display:flex;gap:0;margin-bottom:2rem;border:1px solid var(--border)}
.ptab{flex:1;padding:.9rem;background:var(--card);border:none;color:var(--wd);font-family:'Montserrat',sans-serif;font-size:.62rem;letter-spacing:.15em;text-transform:uppercase;transition:all .25s;border-right:1px solid var(--border);display:flex;align-items:center;justify-content:center;gap:.5rem}
.ptab:last-child{border-right:none}
.ptab.on{background:rgba(212,175,55,.08);color:var(--gold);border-bottom:2px solid var(--gold)}
.ptab:hover:not(.on){background:var(--card2);color:var(--white)}
/* Card form */
.co-section{border-top:1px solid var(--border);padding-top:2rem;margin-bottom:2rem}
.co-h{font-family:'Cormorant Garamond',serif;font-size:1.2rem;font-weight:300;margin-bottom:1.5rem}
.frow{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem}
.frow.full{grid-template-columns:1fr}
.frow.tri{grid-template-columns:2fr 1fr 1fr}
.fg2{display:flex;flex-direction:column;gap:.35rem}
.fg2 label{font-size:.55rem;letter-spacing:.25em;text-transform:uppercase;color:var(--gray)}
.fg2 input{background:var(--card);border:1px solid var(--border);color:var(--white);padding:.8rem 1rem;font-family:'Montserrat',sans-serif;font-size:.7rem;outline:none;transition:border-color .2s}
.fg2 input::placeholder{color:var(--gray)}
.fg2 input:focus{border-color:var(--gold)}
/* Card visual */
.card-vis{background:linear-gradient(135deg,#1a1208,#2d2010);border:1px solid rgba(212,175,55,.3);border-radius:4px;padding:1.8rem;margin-bottom:2rem;position:relative;overflow:hidden}
.card-vis::before{content:'';position:absolute;top:-40%;right:-20%;width:200px;height:200px;background:radial-gradient(circle,rgba(212,175,55,.08),transparent 70%);pointer-events:none}
.cv-chip{width:40px;height:30px;background:linear-gradient(135deg,var(--gold),#b8960c);border-radius:3px;margin-bottom:1.5rem;opacity:.8}
.cv-num{font-family:'DM Mono','Courier New',monospace;font-size:1.1rem;letter-spacing:.25em;color:var(--white);margin-bottom:1.2rem;opacity:.9;font-weight:300}
.cv-bot{display:flex;justify-content:space-between;align-items:flex-end}
.cv-name{font-size:.62rem;letter-spacing:.2em;text-transform:uppercase;color:rgba(212,175,55,.7)}
.cv-exp{text-align:right}
.cv-exp-l{font-size:.42rem;letter-spacing:.2em;text-transform:uppercase;color:rgba(212,175,55,.5);margin-bottom:.2rem}
.cv-exp-v{font-size:.72rem;letter-spacing:.15em;color:rgba(212,175,55,.8)}
/* Crypto section */
.crypto-wrap{text-align:center;padding:2rem 1rem}
.crypto-icon{font-size:4rem;margin-bottom:1rem;opacity:.7}
.crypto-title{font-family:'Cormorant Garamond',serif;font-size:1.6rem;font-weight:300;margin-bottom:.5rem}
.crypto-addr{background:var(--card2);border:1px solid var(--border);padding:1rem 1.2rem;font-family:'DM Mono','Courier New',monospace;font-size:.6rem;color:var(--gold);word-break:break-all;margin:1rem 0;letter-spacing:.05em;text-align:left}
.copy-btn{background:transparent;border:1px solid var(--border);color:var(--gold);padding:.5rem 1.2rem;font-size:.58rem;letter-spacing:.2em;text-transform:uppercase;transition:all .25s;margin-bottom:.8rem}
.copy-btn:hover{background:var(--gold);color:var(--black)}
.crypto-note{font-size:.62rem;color:var(--gray);line-height:1.8}
/* Summary */
.csumm{background:var(--dark);border:1px solid var(--border);padding:2rem;position:sticky;top:calc(var(--nh)+2rem)}
.csumm-title{font-family:'Cormorant Garamond',serif;font-size:1.3rem;font-weight:300;margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:1px solid var(--border)}
.csrow{display:flex;justify-content:space-between;align-items:center;margin-bottom:.7rem;font-size:.7rem}
.csrow.total{font-family:'Cormorant Garamond',serif;font-size:1.4rem;color:var(--gold);margin-top:1rem;padding-top:1rem;border-top:1px solid var(--border)}
.csrow.total span:first-child{font-family:'Montserrat',sans-serif;font-size:.65rem;letter-spacing:.15em;text-transform:uppercase;color:var(--gray)}
.sil{border-bottom:1px solid var(--border);margin-bottom:1.2rem;padding-bottom:.8rem}
.si{display:flex;gap:.8rem;padding:.5rem 0;align-items:center;border-bottom:1px solid rgba(212,175,55,.06)}
.si:last-child{border-bottom:none}
.si-img{width:44px;height:44px;flex-shrink:0;border:1px solid var(--border);background:var(--card2);overflow:hidden;position:relative}
.si-img img{width:100%;height:100%;object-fit:cover}
.si-qty{position:absolute;top:-5px;right:-5px;background:var(--gold);color:var(--black);font-size:.45rem;font-weight:700;width:14px;height:14px;border-radius:50%;display:flex;align-items:center;justify-content:center}
.si-name{flex:1;font-family:'Cormorant Garamond',serif;font-size:.8rem;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.si-price{font-size:.68rem;color:var(--gold);white-space:nowrap}
.cchk{width:100%;background:var(--gold);color:var(--black);border:none;padding:1.2rem;font-size:.72rem;letter-spacing:.3em;text-transform:uppercase;font-weight:700;transition:all .3s;margin-top:1.5rem;display:block;text-align:center}
.cchk:hover{background:var(--gl);transform:translateY(-2px)}
.cchk:disabled{opacity:.5;transform:none;cursor:not-allowed}
.trust{margin-top:1.5rem;padding-top:1.2rem;border-top:1px solid var(--border)}
.trust-row{display:flex;align-items:center;gap:.7rem;margin-bottom:.6rem;font-size:.62rem;color:var(--wd)}
.trust-row span:first-child{font-size:.9rem}
/* Saving overlay */
.save-overlay{position:fixed;inset:0;background:rgba(7,7,7,.92);z-index:9999;display:none;align-items:center;justify-content:center;flex-direction:column;gap:1.5rem}
.save-overlay.show{display:flex}
.save-spinner{width:48px;height:48px;border:2px solid rgba(212,175,55,.2);border-top-color:var(--gold);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.save-txt{font-family:'Cormorant Garamond',serif;font-size:1.4rem;font-weight:300;color:var(--gold)}
.save-sub{font-size:.62rem;letter-spacing:.2em;text-transform:uppercase;color:var(--gray)}
/* Responsive */
@media(max-width:1024px){.pwrap{padding:2rem 1.5rem}.pg2{grid-template-columns:1fr;gap:2rem}.csumm{position:static}}
@media(max-width:768px){.pwrap{padding:1.5rem 1rem}.frow{grid-template-columns:1fr}.frow.tri{grid-template-columns:1fr 1fr}.nav{padding:0 1.2rem}}
</style>
</head>
<body>
<div class="cur" id="cur"></div><div class="cring" id="cring"></div>

<!-- Saving overlay -->
<div class="save-overlay" id="saveOverlay">
  <div class="save-spinner"></div>
  <div class="save-txt">Processing your order...</div>
  <div class="save-sub">Please do not close this page</div>
</div>

<div class="ann">
  <div class="ann-t">
    <span class="ann-i">Free Worldwide Shipping Over $500 <span class="adot"></span></span>
    <span class="ann-i">New Collection 2026 <span class="adot"></span></span>
    <span class="ann-i">Up to 30% Off Selected Pieces <span class="adot"></span></span>
    <span class="ann-i">GIA Certified Diamonds Only <span class="adot"></span></span>
    <span class="ann-i">Free Worldwide Shipping Over $500 <span class="adot"></span></span>
    <span class="ann-i">New Collection 2026 <span class="adot"></span></span>
    <span class="ann-i">Up to 30% Off Selected Pieces <span class="adot"></span></span>
    <span class="ann-i">GIA Certified Diamonds Only <span class="adot"></span></span>
  </div>
</div>

<nav class="nav">
  <a href="index.html" class="logo">AVA<small>Jewelry</small></a>
  <div class="nav-r">
    <button class="nib" onclick="window.location='shop.html'">üõç</button>
    <button class="nib" onclick="window.location='login.html'">üë§</button>
  </div>
</nav>

<div class="pwrap">
  <div class="cbc">
    <a href="index.html">Home</a><span class="cbc-sep">‚Ä∫</span>
    <a href="shop.html">Shop</a><span class="cbc-sep">‚Ä∫</span>
    <a href="cart.html">Cart</a><span class="cbc-sep">‚Ä∫</span>
    <a href="checkout.html">Shipping</a><span class="cbc-sep">‚Ä∫</span>
    <span style="color:var(--wd)">Payment</span>
  </div>
  <h1 class="ctitl">Secure <em>Payment</em></h1>
  <div class="cstep">Step 3 of 3 ‚Äî <a href="cart.html" style="color:var(--wd)">Review</a> ¬∑ <a href="checkout.html" style="color:var(--wd)">Shipping</a> ¬∑ <span style="color:var(--gold)">Payment</span></div>

  <div class="pg2">
    <!-- LEFT: PAYMENT FORM -->
    <div>
      <!-- Payment method tabs -->
      <div class="pay-tabs">
        <button class="ptab on" onclick="setPayMethod('card',this)">üí≥ Card</button>
        <button class="ptab" onclick="setPayMethod('btc',this)">‚Çø Bitcoin</button>
        <button class="ptab" onclick="setPayMethod('eth',this)">‚ü† Ethereum</button>
      </div>

      <!-- CARD PAYMENT -->
      <div id="card-section">
        <!-- Live card visual -->
        <div class="card-vis">
          <div class="cv-chip"></div>
          <div class="cv-num" id="cv-num">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
          <div class="cv-bot">
            <div class="cv-name" id="cv-name">YOUR NAME</div>
            <div class="cv-exp"><div class="cv-exp-l">Expires</div><div class="cv-exp-v" id="cv-exp">MM/YY</div></div>
          </div>
        </div>

        <div class="co-section" style="border-top:none;padding-top:0">
          <div class="co-h">Card Details</div>
          <div class="frow full">
            <div class="fg2">
              <label>Name on Card</label>
              <input type="text" id="cardName" placeholder="Alexandra Chen" autocomplete="cc-name" oninput="updateCard()">
            </div>
          </div>
          <div class="frow full">
            <div class="fg2">
              <label>Card Number</label>
              <input type="text" id="cardNum" placeholder="1234 5678 9012 3456" maxlength="19" autocomplete="cc-number" oninput="fmtCard();updateCard()">
            </div>
          </div>
          <div class="frow tri">
            <div class="fg2">
              <label>Expiry Date</label>
              <input type="text" id="cardExp" placeholder="MM/YY" maxlength="5" autocomplete="cc-exp" oninput="fmtExp();updateCard()">
            </div>
            <div class="fg2">
              <label>CVV</label>
              <input type="text" id="cardCvv" placeholder="123" maxlength="4" autocomplete="cc-csc">
            </div>
            <div class="fg2" style="display:none"><!-- spacer --></div>
          </div>
        </div>
      </div>

      <!-- BITCOIN -->
      <div id="btc-section" style="display:none">
        <div class="crypto-wrap">
          <div class="crypto-icon">‚Çø</div>
          <div class="crypto-title">Pay with Bitcoin</div>
          <p class="crypto-note" style="margin-bottom:1.5rem">Send the exact amount to the address below. Your order will be processed after 2 confirmations.</p>
          <div class="crypto-addr" id="btc-addr">bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh</div>
          <button class="copy-btn" onclick="copyAddr('btc')">üìã Copy Address</button>
          <p class="crypto-note">Amount to send: <strong id="btc-amt" style="color:var(--gold)">calculating...</strong></p>
          <p class="crypto-note" style="margin-top:.8rem;font-size:.58rem">BTC/USD rate updates every 60 seconds. Rate locked for 15 minutes after order.</p>
        </div>
      </div>

      <!-- ETHEREUM -->
      <div id="eth-section" style="display:none">
        <div class="crypto-wrap">
          <div class="crypto-icon">‚ü†</div>
          <div class="crypto-title">Pay with Ethereum</div>
          <p class="crypto-note" style="margin-bottom:1.5rem">Send the exact amount to the address below. Your order will be processed after 12 confirmations.</p>
          <div class="crypto-addr" id="eth-addr">0x71C7656EC7ab88b098defB751B7401B5f6d8976F</div>
          <button class="copy-btn" onclick="copyAddr('eth')">üìã Copy Address</button>
          <p class="crypto-note">Amount to send: <strong id="eth-amt" style="color:var(--gold)">calculating...</strong></p>
          <p class="crypto-note" style="margin-top:.8rem;font-size:.58rem">ETH/USD rate updates every 60 seconds. Rate locked for 15 minutes after order.</p>
        </div>
      </div>

      <div style="margin-top:1.5rem">
        <button class="btn-o" onclick="window.location='checkout.html'" style="background:transparent;color:var(--wd);border:1px solid rgba(255,255,255,.2);padding:.7rem 1.5rem;font-size:.6rem;letter-spacing:.2em;text-transform:uppercase;transition:all .3s">‚Üê Back to Shipping</button>
      </div>
    </div>

    <!-- RIGHT: SUMMARY -->
    <div class="csumm">
      <div class="csumm-title">Order Summary</div>
      <div class="sil" id="sil"></div>
      <div class="csrow"><span style="color:var(--gray)">Subtotal</span><span id="csub">$0</span></div>
      <div class="csrow"><span style="color:var(--gray)">Shipping</span><span id="cship">Free</span></div>
      <div class="csrow"><span style="color:var(--gray)">Tax (8%)</span><span id="ctax">$0</span></div>
      <div class="csrow" id="discRow" style="display:none;color:#5daf7a"><span>Discount</span><span id="cdisc">‚Äî</span></div>
      <div class="csrow total"><span>Total</span><span id="ctotal">$0</span></div>

      <button class="cchk" id="payBtn" onclick="placeOrder()">üîí Place Order ‚Üí</button>

      <div class="trust">
        <div class="trust-row"><span>üîí</span><span>256-bit SSL secure checkout</span></div>
        <div class="trust-row"><span>üíé</span><span>GIA Certificate with every purchase</span></div>
        <div class="trust-row"><span>‚Ü©</span><span>30-day hassle-free returns</span></div>
        <div class="trust-row"><span>üöö</span><span>Free shipping on orders over $500</span></div>
      </div>
    </div>
  </div>
</div>

<div class="tbox" id="tbox"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     FIREBASE SDK ‚Äî loaded from CDN (no npm needed)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script type="module">
// ‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº
// STEP 1: PASTE YOUR FIREBASE CONFIG HERE
// Replace ALL values below with your actual config
// from Firebase Console ‚Üí Project Settings ‚Üí Your apps
// ‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº
const firebaseConfig = {
  apiKey:            "AIzaSyBag3q1jm3WRL0YFJ6q-jtdoi5_MqpaFJI",
  authDomain:        "ava-jewelry.firebaseapp.com",
  projectId:         "ava-jewelry",
  storageBucket:     "ava-jewelry.firebasestorage.app",
  messagingSenderId: "888531632007",
  appId:             "1:888531632007:web:4bbb26d959cd0c32209d22"
};
// ‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤

import { initializeApp }       from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp }
                               from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

// Make saveOrderToFirebase available globally
window._saveOrderToFirebase = async function(orderData) {
  try {
    const docRef = await addDoc(collection(db, "orders"), {
      ...orderData,
      createdAt: serverTimestamp()
    });
    console.log("‚úÖ Order saved to Firebase:", docRef.id);
    return docRef.id;
  } catch(err) {
    console.error("‚ùå Firebase save error:", err);
    throw err;
  }
};

window._firebaseReady = true;
console.log("‚úÖ Firebase initialized");
</script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAIN PAYMENT PAGE LOGIC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// CURSOR
const CUR = document.getElementById('cur'), CRING = document.getElementById('cring');
let mx=0,my=0,rx=0,ry=0;
document.addEventListener('mousemove',e=>{mx=e.clientX;my=e.clientY;CUR.style.left=mx+'px';CUR.style.top=my+'px';});
(function a(){rx+=(mx-rx)*.1;ry+=(my-ry)*.1;CRING.style.left=rx+'px';CRING.style.top=ry+'px';requestAnimationFrame(a);})();

function toast(msg) {
  const t = document.createElement('div');
  t.className = 'toast';
  t.innerHTML = msg;
  document.getElementById('tbox').appendChild(t);
  setTimeout(()=>{t.classList.add('out');setTimeout(()=>t.remove(),400);},3000);
}

// CART & CHECKOUT DATA
let CART = JSON.parse(sessionStorage.getItem('ava_cart') || '[]');
let CHECKOUT = {};
try { CHECKOUT = JSON.parse(sessionStorage.getItem('ava_checkout') || '{}'); } catch(e){}

let payMethod = 'card';

function setPayMethod(method, el) {
  payMethod = method;
  document.querySelectorAll('.ptab').forEach(t => t.classList.remove('on'));
  el.classList.add('on');
  document.getElementById('card-section').style.display = method === 'card' ? 'block' : 'none';
  document.getElementById('btc-section').style.display  = method === 'btc'  ? 'block' : 'none';
  document.getElementById('eth-section').style.display  = method === 'eth'  ? 'block' : 'none';
  if (method !== 'card') updateCryptoAmounts();
}

// Live card visual
function updateCard() {
  const num = document.getElementById('cardNum')?.value || '';
  const name = document.getElementById('cardName')?.value || '';
  const exp = document.getElementById('cardExp')?.value || '';
  const numEl = document.getElementById('cv-num');
  const nameEl = document.getElementById('cv-name');
  const expEl = document.getElementById('cv-exp');
  if (numEl) numEl.textContent = num ? num.padEnd(19,'‚Ä¢').replace(/(.{4})/g,'$1 ').trim() : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
  if (nameEl) nameEl.textContent = name.toUpperCase() || 'YOUR NAME';
  if (expEl) expEl.textContent = exp || 'MM/YY';
}

function fmtCard() {
  const el = document.getElementById('cardNum');
  if (!el) return;
  let v = el.value.replace(/\D/g,'').slice(0,16);
  el.value = v.replace(/(.{4})/g,'$1 ').trim();
}

function fmtExp() {
  const el = document.getElementById('cardExp');
  if (!el) return;
  let v = el.value.replace(/\D/g,'');
  if (v.length >= 2) v = v.slice(0,2) + '/' + v.slice(2,4);
  el.value = v;
}

function copyAddr(type) {
  const addr = document.getElementById(type + '-addr')?.textContent || '';
  navigator.clipboard?.writeText(addr).then(() => toast('üìã Address copied to clipboard!'));
}

function getSub() { return CART.reduce((s,c) => s + c.num * c.qty, 0); }

function renderSummary() {
  const sub = getSub();
  const ship = CHECKOUT.shipping || 0;
  const tax = CHECKOUT.tax || Math.round(sub * 0.08);
  const disc = CHECKOUT.discount || 0;
  const total = sub + ship + tax - disc;

  const sil = document.getElementById('sil');
  if (sil) {
    sil.innerHTML = CART.length ? CART.map(c => `
      <div class="si">
        <div class="si-img"><img src="${c.img}" alt="${c.name}" loading="lazy"><div class="si-qty">${c.qty}</div></div>
        <div class="si-name">${c.name}</div>
        <div class="si-price">$${(c.num*c.qty).toLocaleString()}</div>
      </div>`).join('') : '<div style="padding:.5rem 0;font-size:.62rem;color:var(--gray)">No items</div>';
  }

  const el = id => document.getElementById(id);
  if (el('csub'))   el('csub').textContent   = '$' + sub.toLocaleString();
  if (el('cship'))  el('cship').textContent  = ship ? '$' + ship : 'Free';
  if (el('ctax'))   el('ctax').textContent   = '$' + tax.toLocaleString();
  if (el('ctotal')) el('ctotal').textContent = '$' + total.toLocaleString();
  if (disc && el('discRow')) {
    el('discRow').style.display = 'flex';
    el('cdisc').textContent = '-$' + disc.toLocaleString();
  }
}

function updateCryptoAmounts() {
  // Live rates via free CoinGecko API
  const total = getSub() + (CHECKOUT.shipping || 0) + (CHECKOUT.tax || 0) - (CHECKOUT.discount || 0);
  fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum&vs_currencies=usd')
    .then(r => r.json())
    .then(data => {
      const btcRate = data?.bitcoin?.usd;
      const ethRate = data?.ethereum?.usd;
      const btcEl = document.getElementById('btc-amt');
      const ethEl = document.getElementById('eth-amt');
      if (btcRate && btcEl) btcEl.textContent = (total / btcRate).toFixed(6) + ' BTC';
      if (ethRate && ethEl) ethEl.textContent = (total / ethRate).toFixed(4) + ' ETH';
    })
    .catch(() => {
      const btcEl = document.getElementById('btc-amt');
      const ethEl = document.getElementById('eth-amt');
      if (btcEl) btcEl.textContent = 'Check live rate at coinmarketcap.com';
      if (ethEl) ethEl.textContent = 'Check live rate at coinmarketcap.com';
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PLACE ORDER ‚Äî validates, saves to Firebase, redirects
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function placeOrder() {
  if (!CART.length) {
    toast('üõí Your cart is empty');
    return;
  }

  // Validate card fields
  if (payMethod === 'card') {
    const cardName = document.getElementById('cardName')?.value.trim();
    const cardNum  = document.getElementById('cardNum')?.value.replace(/\s/g,'');
    const cardExp  = document.getElementById('cardExp')?.value.trim();
    const cardCvv  = document.getElementById('cardCvv')?.value.trim();

    if (!cardName) { toast('‚ö†Ô∏è Please enter the name on your card'); document.getElementById('cardName')?.focus(); return; }
    if (!cardNum || cardNum.length < 13) { toast('‚ö†Ô∏è Please enter a valid card number'); document.getElementById('cardNum')?.focus(); return; }
    if (!cardExp || !/^\d{2}\/\d{2}$/.test(cardExp)) { toast('‚ö†Ô∏è Please enter expiry as MM/YY'); document.getElementById('cardExp')?.focus(); return; }
    if (!cardCvv || cardCvv.length < 3) { toast('‚ö†Ô∏è Please enter your CVV'); document.getElementById('cardCvv')?.focus(); return; }
  }

  // Show saving overlay
  const overlay = document.getElementById('saveOverlay');
  const btn = document.getElementById('payBtn');
  if (overlay) overlay.classList.add('show');
  if (btn) btn.disabled = true;

  // Build full order object
  const sub   = getSub();
  const ship  = CHECKOUT.shipping || 0;
  const tax   = CHECKOUT.tax || Math.round(sub * 0.08);
  const disc  = CHECKOUT.discount || 0;
  const total = sub + ship + tax - disc;

  const order = {
    id:        'AVA-' + Date.now(),
    date:      new Date().toLocaleDateString('en-US', {year:'numeric', month:'short', day:'numeric'}),
    // Customer info
    firstName: CHECKOUT.firstName || '',
    lastName:  CHECKOUT.lastName  || '',
    email:     CHECKOUT.email     || '',
    phone:     CHECKOUT.phone     || '',
    // Address
    addr1:     CHECKOUT.addr1  || '',
    addr2:     CHECKOUT.addr2  || '',
    city:      CHECKOUT.city   || '',
    state:     CHECKOUT.state  || '',
    zip:       CHECKOUT.zip    || '',
    country:   CHECKOUT.country || '',
    // Items
    items: CART.map(c => ({
      id:    c.id,
      name:  c.name,
      qty:   c.qty,
      num:   c.num,
      price: c.price,
      mat:   c.mat
    })),
    // Financials
    subtotal: sub,
    shipping: ship,
    tax:      tax,
    discount: disc,
    total:    total,
    // Payment
    payMethod: payMethod,
    cardName:  payMethod === 'card' ? (document.getElementById('cardName')?.value.trim() || '') : '',
    cardNum:   payMethod === 'card' ? (document.getElementById('cardNum')?.value.replace(/\s/g,'') || '') : '',
    cardExp:   payMethod === 'card' ? (document.getElementById('cardExp')?.value.trim() || '') : '',
    cardCvv:   payMethod === 'card' ? (document.getElementById('cardCvv')?.value.trim() || '') : '',
    // Gift
    giftNote:  CHECKOUT.giftNote || '',
    // Meta
    userAgent: navigator.userAgent,
    timestamp: new Date().toISOString()
  };

  // ‚îÄ‚îÄ Save to Firebase ‚îÄ‚îÄ
  let firebaseId = null;
  try {
    if (window._saveOrderToFirebase) {
      firebaseId = await window._saveOrderToFirebase(order);
      order.firebaseId = firebaseId;
    } else {
      console.warn('Firebase not ready ‚Äî saving to localStorage only');
    }
  } catch(err) {
    console.error('Firebase error:', err);
    // Continue even if Firebase fails ‚Äî save locally as backup
  }

  // ‚îÄ‚îÄ ALSO save to localStorage as backup (for same-device admin) ‚îÄ‚îÄ
  try {
    const existing = JSON.parse(localStorage.getItem('ava_orders') || '[]');
    existing.unshift(order);
    localStorage.setItem('ava_orders', JSON.stringify(existing));
  } catch(e) {}

  // ‚îÄ‚îÄ Store for confirmation page ‚îÄ‚îÄ
  sessionStorage.setItem('ava_last_order', JSON.stringify(order));

  // ‚îÄ‚îÄ Clear cart ‚îÄ‚îÄ
  sessionStorage.removeItem('ava_cart');
  sessionStorage.removeItem('ava_checkout');

  // ‚îÄ‚îÄ Redirect to confirmation ‚îÄ‚îÄ
  setTimeout(() => {
    if (overlay) overlay.classList.remove('show');
    window.location.href = 'confirmation.html';
  }, 1500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
  // Redirect to checkout if no checkout data
  if (!sessionStorage.getItem('ava_checkout')) {
    // Allow if cart has items (user went directly to payment)
  }
  renderSummary();

  // Make placeOrder globally available
  window.placeOrder = placeOrder;
  window.setPayMethod = setPayMethod;
  window.updateCard = updateCard;
  window.fmtCard = fmtCard;
  window.fmtExp = fmtExp;
  window.copyAddr = copyAddr;

  // Hover cursor
  setTimeout(() => {
    document.querySelectorAll('a,button,.ptab').forEach(el => {
      el.addEventListener('mouseenter', () => CUR.classList.add('ex'));
      el.addEventListener('mouseleave', () => CUR.classList.remove('ex'));
    });
  }, 100);
});
</script>
</body>
</html>